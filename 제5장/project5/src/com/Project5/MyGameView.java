package com.Project5;

import java.util.*;

import android.content.*;
import android.graphics.*;
import android.util.*;
import android.view.*;
import android.view.SurfaceHolder.Callback;

public class MyGameView extends SurfaceView implements Callback {
	GameThread mThread;
	SurfaceHolder mHolder;
	Context mContext;

	final int LEFT = 1;		// 거미 이동 방향
	final int RIGHT = 2;
	
	//-------------------------------------
	//  생성자
	//-------------------------------------
	public MyGameView(Context context, AttributeSet attrs) {
		super(context, attrs);
		SurfaceHolder holder = getHolder();
		holder.addCallback(this);
		mHolder = holder;		// holder와 Context 보존
		mContext = context;
		mThread = new GameThread(holder, context);
		
		setFocusable(true);
	}

	//-------------------------------------
    //  SurfaceView가 생성될 때 실행되는 부분
    //-------------------------------------
	@Override
	public void surfaceCreated(SurfaceHolder holder) {
		mThread.start();
	}

	//-------------------------------------
    //  SurfaceView가 바뀔 때 실행되는 부분
    //-------------------------------------
	@Override
	public void surfaceChanged(SurfaceHolder arg0, int format, int width, int height) {

	}

	//-------------------------------------
    //  SurfaceView가 해제될 때 실행되는 부분
    //-------------------------------------
	@Override
	public void surfaceDestroyed(SurfaceHolder holder) {
		boolean done = true;
	    while (done) {
	    	try {
	    		mThread.join();        // 스레드가 현재 step을 끝낼 때 까지 대기
	    		done = false;
	 		} catch (InterruptedException e) {  // 인터럽트 신호가 오면?   
	 			// 그 신호 무시 - 아무것도 않음
	 		} 
	    } // while
	}
	
	//-------------------------------------
	//  스레드 완전 정지
	//-------------------------------------
	public void StopGame() {
		mThread.StopThread(); 
	}

	//-------------------------------------
	//  스레드 일시 정지
	//-------------------------------------
	public void PauseGame() {
		mThread.PauseNResume(true); 
	}

	//-------------------------------------
	//  스레드 재기동
	//-------------------------------------
	public void ResumeGame() {
		mThread.PauseNResume(false); 
	}

	//-------------------------------------
	//  게임 초기화
	//-------------------------------------
	public void RestartGame() {
		mThread.StopThread();		// 스레드 중지

		// 현재의 스레드를 비우고 다시 생성
	    mThread = null;	  
		mThread = new GameThread(mHolder, mContext); 
		mThread.start(); 
	}

//----------------------------------------------------------------
	
	//-------------------------------------
	//  GameThread Class
	//-------------------------------------
	class GameThread extends Thread {
		SurfaceHolder mHolder;		// SurfaceHolder를 저장할 변수
		Context mContext;
		
		int width, height;
		Bitmap imgBack;				// 배경
		Bitmap imgSmall; 			// 남은 거미 갯수 표시용
		int Tot = 0;				// 득점 합계
		
		ArrayList<Bubble> mBall = new ArrayList<Bubble>();			// 큰방울
		ArrayList<SmallBall> sBall = new ArrayList<SmallBall>();	// 작은방울
		ArrayList<WaterBall> wBall = new ArrayList<WaterBall>();	// 거미 총알
		ArrayList<Spider> mSpider = new ArrayList<Spider>();		// 거미 총알
		ArrayList<Score> mScore = new ArrayList<Score>();			// 득점
		Score totScore;												// 총점 표시용
		
		long lastTime;					// 직전시간
		int SpiderCnt;
		boolean canRun = true;			// 스레드 제어용
		boolean isWait = false;
		  
		//-------------------------------------
		//  생성자 
		//-------------------------------------
		public GameThread(SurfaceHolder holder, Context context) {
			mHolder = holder;	// SurfaceHolder 보존
			mContext = context;
			
			Display display = ((WindowManager) context.getSystemService (Context.WINDOW_SERVICE)).getDefaultDisplay();
			width = display.getWidth();		// View의 가로 폭
			height = display.getHeight() - 50;   // View의 세로 높이

			imgBack = BitmapFactory.decodeResource(getResources(), R.drawable.sky);
			imgBack = Bitmap.createScaledBitmap(imgBack, width, height, false);
			// 작은 거미 - 남은 거미 갯수 표시용
			imgSmall = BitmapFactory.decodeResource(getResources(), R.drawable.spider1);
			imgSmall = Bitmap.createScaledBitmap(imgSmall, 20, 20, false);
			
			totScore = new Score(mContext, 0, 0, 0);	// 총점 표시용 Class
			
			InitGame();			// 게임 초기화 - 게임 오버 후 다시 실행을 위해 필요하다
		}
		
		//-------------------------------------
		//  게임 초기화 
		//-------------------------------------
		public void InitGame() {
			SpiderCnt = 4;	// 남은 거미 갯수 (0~4)
			// 거미 만들기
			for (int i = 0; i <= SpiderCnt; i++)
				mSpider.add(new Spider(mContext, width / 2, height - 40, width));
		}
		
		//-------------------------------------
		//  큰 비눗방울 만들기 
		//-------------------------------------
		public void MakeBubble() {
			Random rnd = new Random();
			if (mBall.size() > 9 || rnd.nextInt(40) < 38) return;
			int x = rnd.nextInt(width - 100) + 50;	// 50 ~ width-50 
			int y = rnd.nextInt(height - 200) + 50;	// 50 ~ height-150 
			mBall.add(new Bubble(mContext, x, y, width, height));
		}	
			
		//-------------------------------------
		//  작은  비눗방울 만들기
		//-------------------------------------
		private void MakeSmallBall(int x, int y) {
			Random rnd = new Random();
			int count = rnd.nextInt(9) + 7;   // 7~15개
			for (int i = 1; i <= count; i++) {
				int ang = rnd.nextInt(360);		 
				sBall.add(new SmallBall(mContext, x, y, ang, width, height));
			}
		}

		//-------------------------------------
		//  모든 캐릭터 이동  
		//-------------------------------------
		public void MoveCharacters() {
			// 큰 비눗방울
			for (int i = mBall.size() - 1; i >= 0; i--) {
				mBall.get(i).MoveBubble();
				if (mBall.get(i).dead == true) mBall.remove(i);  
			}	
			// 작은 비눗방울
			for (int i = sBall.size() - 1; i >= 0; i--) {
				sBall.get(i).MoveBall();
				if (sBall.get(i).dead == true)
					sBall.remove(i);
			}	
			// 거미 총알
			for (int i = wBall.size() - 1; i >= 0; i--) {
				wBall.get(i).MoveBall();
				if (wBall.get(i).dead == true)
					wBall.remove(i);
			}
			// 점수
			for (int i = mScore.size() - 1; i >= 0; i--)
				if (mScore.get(i).Move() == false)
					mScore.remove(i);
			// 거미 무적모드
			mSpider.get(SpiderCnt).UndeadMode();
		}

		//-------------------------------------
		//  거미 이동 - KeyDown에서 호출
		//-------------------------------------
		private void MoveSpider(int n) {
			if (n == LEFT) mSpider.get(SpiderCnt).MoveLeft();
			if (n == RIGHT) mSpider.get(SpiderCnt).MoveRight();
		}

		//-------------------------------------
		//  거미 총알 발사 - KeyDown에서 호출
		//-------------------------------------
		private void MakeWaterBall() {
			long thisTime = System.currentTimeMillis();
			if (thisTime - lastTime >= 300) {	// 1/3초에 1개씩 발사
				Spider tmp = mSpider.get(SpiderCnt);
				wBall.add(new WaterBall(mContext, tmp.x, tmp.y - 5, width, height));
			}
			lastTime = thisTime;
		}

		//-------------------------------------
		//  충돌 판정
		//-------------------------------------
		public void CheckCollision() {
			int x1, y1, x2, y2;
			int score = new Random().nextInt(101) + 100;	// 100~200;

			// 비눗방울과 거미의 충돌
			Spider spd = mSpider.get(SpiderCnt);
			for (Bubble tmp : mBall) {
				x1 = Math.abs(spd.x - tmp.x);
				y1 = Math.abs(spd.y - tmp.y);
				if (x1 < spd.sw + tmp.rad && y1 < spd.sh + tmp.rad) {
					MakeSmallBall(tmp.x, tmp.y);	// 작은 풍선 만들고
					// 거미 자살도 점수 부여함 - 풍선이 터지므로...
					mScore.add(new Score(mContext, tmp.x, tmp.y, score));	// 점수 만들고
					tmp.dead = true;					// 큰풍선 터뜨림
					Tot += score;						// 총점도 더하고 
					if (spd.undead == false) {			// 무적 모드가 아니면
						mSpider.remove(SpiderCnt);		// 거미 하나 지우고
						SpiderCnt--;					// 거미 수도 줄이고
						if (SpiderCnt < 0) GameOver();	// 남은 거미 없으면 게임 오버
					}	
				}
			} // for	
			
			// 총알과 비눗방울의 충돌
			for (WaterBall water : wBall) {	// 총알
				x1 = water.x;
				y1 = water.y;
				for (Bubble tmp : mBall) {	// 비눗방울 
					x2 = tmp.x;
					y2 = tmp.y;
					if (Math.abs(x1 - x2) < tmp.rad && Math.abs(y1 - y2) < tmp.rad) {
						MakeSmallBall(tmp.x, tmp.y);	// 작은 풍선 만들고
						mScore.add(new Score(mContext, tmp.x, tmp.y, score));	// 점수 만들고
						tmp.dead = true;				// 큰풍선 터뜨림
						water.dead = true;				// 총알도 없애고
						Tot += score;					// 총점도 더하고 
						break;
					}
				} // for
			} // for	
		}

		//-------------------------------------
		//  Game Over
		//-------------------------------------
		private void GameOver() {
			// 게임 오버는 여기에서 처리힌다
			InitGame();
		}
		
		//-------------------------------------
		//  Canvas에 그리기
		//-------------------------------------
		public void DrawCharacters(Canvas canvas) {
			canvas.drawBitmap(imgBack, 0, 0, null);		// 배경
			// 남은 거미 수
			for (int i= 0; i <= SpiderCnt; i++)
				canvas.drawBitmap(imgSmall, i*20 + 2, height - 20, null);
			
			// 큰 비눗방울
			for (Bubble tmp : mBall)
				canvas.drawBitmap(tmp.imgBall, tmp.x - tmp.rad,  tmp.y - tmp.rad, null);
			// 작은비눗방울
			for (SmallBall tmp : sBall)
				canvas.drawBitmap(tmp.imgBall, tmp.x - tmp.rad,  tmp.y - tmp.rad, null);
			// 거미 물방울
			for (WaterBall tmp : wBall)
				canvas.drawBitmap(tmp.imgBall, tmp.x - tmp.rad,  tmp.y - tmp.rad, null);
			// 득점
			for (Score tmp : mScore)
				canvas.drawBitmap(tmp.imgScore, tmp.x - tmp.sw,  tmp.y - tmp.sh, null);
			// 총점
			totScore.MakeScore(Tot);	// 총점을 그래픽 이미지로 만들기
			canvas.drawBitmap(totScore.imgScore, 10, 10, null);

			// 거미
			Spider tmp = mSpider.get(SpiderCnt);
			canvas.drawBitmap(tmp.imgSpider, tmp.x - tmp.sw, tmp.y - tmp.sh, null);    
		}
		
		//-------------------------------------
		//  스레드 본체
		//-------------------------------------
		public void run() {
			Canvas canvas = null; 					// canvas를 만든다
			while (canRun) {
				canvas = mHolder.lockCanvas();		// canvas를 잠그고 버퍼 할당
				try {
					synchronized (mHolder) {		// 동기화 유지
						MakeBubble();
						MoveCharacters();
						CheckCollision();
						DrawCharacters(canvas);
					}
				} finally {							// 버퍼 작업이 끝나면 
					if (canvas != null)				// 버퍼의 내용을 View에 전송
						mHolder.unlockCanvasAndPost(canvas);
				} // try

				// 스레드 일시 정지 
				synchronized (this) {
            		if (isWait)
            			try {
            				wait();
            			} catch (Exception e) {
							// nothing
						}
    			} // sync
				
			} // while
		} // run
	
		//-------------------------------------
		//  스레드 완전 정지
		//-------------------------------------
		public void StopThread() {
			canRun = false;
        	synchronized (this) {
        		this.notify();
			}
		}
		
		//-------------------------------------
		//  스레드 일시정지 / 재기동
		//-------------------------------------
		public void PauseNResume(boolean wait) { 
			isWait = wait;
        	synchronized (this) {
        		this.notify();
			}
		}
		
	} // GameThread 끝

	//-------------------------------------
	//  onKeyDown
	//-------------------------------------
	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) {
		synchronized (mHolder) {
			if (event.getAction() == KeyEvent.ACTION_DOWN) {
				switch (keyCode) {
				case KeyEvent.KEYCODE_DPAD_LEFT :
					mThread.MoveSpider(LEFT);
					break;
				case KeyEvent.KEYCODE_DPAD_RIGHT : 
					mThread.MoveSpider(RIGHT);
					break;
				case KeyEvent.KEYCODE_DPAD_UP : 
					mThread.MakeWaterBall();
				}
			}		
			return super.onKeyDown(keyCode, event);
		} // sync
	} // onKeyDown 
} // SurfaceView 
